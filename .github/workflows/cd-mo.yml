name: cd of springpetclinic
on:
  workflow_dispatch: 
    inputs:
      environment:
        description: "choose environment"
        required: true
        default: "staging"
jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
        - name: checkout repository
          uses: actions/checkout@v4

        - name: aws credntials
          uses: aws-actions/configure-aws-credentials@a03048d87541d1d9fcf2ecf528a4a65ba9bd7838
          with:
            aws-region: eu-central-1
            aws-access-key-id: ${{ secrets.AWS_GITHUB_ACTIONS_ID }}
            aws-secret-access-key: ${{ secrets.AWS_GITHUB_ACTIONS_SECRET }}
          
        - name: download docker on EC2
          run: |
            aws ssm send-command \
              --targets "Key=instanceIds,Values=i-07568d2206758600b" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=[
                "sudo apt-get update -y",
                "sudo apt-get install -y ca-certificates curl gnupg",
                "sudo install -m 0755 -d /etc/apt/keyrings",
                "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg",
                "echo \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null",
                "sudo apt-get update -y",
                "sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin",
                "sudo systemctl enable docker",
                "sudo systemctl start docker"
              ]'
        - name: pull image from docker hub , start container 
          run: |
            aws ssm send-command \
            --targets "Key=instanceIds,Values=i-07568d2206758600b" \
            --document-name "AWS-RunShellScript"
            --parameters 'commands=[
            "sudo docker container run -d --name web -p 8080:8080 deaddeal96/spring-petclinic-githubactions:latest"
            ]'
